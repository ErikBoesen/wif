#!/usr/bin/env python3

import argparse
import os
import json
from getpass import getpass

DATA_PATH = os.path.expanduser('~') + '/.wifdata'

parser = argparse.ArgumentParser(description='Handle internet connections on MacOS.')
parser.add_argument('verb')
parser.add_argument('-n', dest='network', help='Name of network to which to connect')
parser.add_argument('-p', dest='password', help='Password for network to which you wish to connect. USE NOT RECOMMENDED.')
args = parser.parse_args()

networks = {}
if os.path.isfile(DATA_PATH):
    with open(DATA_PATH, 'r') as f:
        networks = json.load(f)
else:
    with open(DATA_PATH, 'w') as f:
        json.dump(networks, f)
    os.chmod(DATA_PATH, stat.S_IRUSR | stat.S_IRUSR)

# Warn if group or public can read config and the private details therein.
if os.stat(DATA_PATH).st_mode & (stat.S_IRGRP | stat.S_IROTH):
    print('Warning: network data file ({path}) may be accessible by other users.'.format(path=DATA_PATH)

if args.verb == 'on':
    # TODO: Detect proper interface, not always en1
    os.system('networksetup -setairportpower en1 on')
elif args.verb == 'off':
    os.system('networksetup -setairportpower en1 off')
# TODO: LIST
elif args.verb == 'connect':
    password = args.password
    if not password:
        password = networks.get(args.network)
    if not password:
        password = getpass()
    networks[args.network] = password
    with open(DATA_PATH, 'w') as f:
        json.dump(networks, f)
    # TODO: Do things in the background/more nicely
    os.system('networksetup -setairportnetwork en1 {network} {password}'.format(network=args.network,
                                                                                password=password))
elif args.verb == 'password':
    os.system('security find-generic-password -wga {network}'.format(network=args.network))
